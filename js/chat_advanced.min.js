var chat_refreshing=false;var chat_disabled=false;var chat_last_message=0;jQuery(document).ready(function(){if(!window.SN_GOOGLE){jQuery(document).on("mouseleave",".chat_unmute, [chat_muted]",function(){$("div#chat_muted_tooltip").css("display","none")})}jQuery("#chat_smile_point, #chat_color_button, #chat_color_select div, #chat_command_menu div:not(:first-child):not(:last-child)").button().addClass("ui-textfield");$("#chat_message_smiles2 div").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-textfield ui-button-text").attr("role","button");if(!IS_HISTORY){height=$("#shoutbox_cell").css("height");$("#shoutbox").css("height",height);$("#online_table").css("height",height);$("#chat_online_div").css("height",$("#chat_online_cell").css("height"));showMessage(true);$("#msg").focus()}});jQuery(document).on("keypress","#msg",function(a){if(a.ctrlKey&&(a.keyCode==13||a.keyCode==10)){jQuery("#send").click()}});jQuery(document).on("click","#chat_player_invisible",function(){addMessage("/invisible "+(jQuery("#chat_player_invisible").is(":checked")?"on":"off"))});jQuery(document).on("click","#chat_online_dragger",function(){if($("#chat_online_wrapper").is(":visible")){$(".js_chat_side_panel").hide("fast");$("#chat_online_dragger").text("<<")}else{$(".js_chat_side_panel").show("fast");$("#chat_online_div").css({height:"100%"});$("#chat_online_dragger").text(">>")}});$(window).resize(function(){clearTimeout(window.resizedFinished);window.resizedFinished=setTimeout(function(){if($("#chat_online_dragger").is(":visible")){$("#chat_online_dragger").text("<<");if($("#chat_online_wrapper").is(":visible")){$(".js_chat_side_panel").hide()}}else{if($("#chat_online_wrapper").is(":not(:visible)")){$(".js_chat_side_panel").show("fast")}}},250)});jQuery(document).on("click",".chat_nick_msg",function(){addSmiley("("+jQuery(this).text()+")")});jQuery(document).on("click","[safe_name]",function(){addSmiley("/w "+(jQuery(this).attr("safe_name")?jQuery(this).attr("safe_name"):jQuery(this).html())+" ",true)});jQuery(document).on("mouseenter","[chat_muted]",function(){that=jQuery(this);tooltip=$("div#chat_muted_tooltip");if(tooltip.css("display")=="none"){tooltip.html(L_chat_advanced_command_mute.replace("%1$s",that.parent().prev().html()).replace("%2$s",that.attr("chat_muted")).replace("%3$s",that.attr("chat_mute_reason")?L_chat_advanced_command_reason.replace("%s",'"'+that.attr("chat_mute_reason"))+'"':"")).css({display:"block",position:"absolute",top:that.position().top+that.height(),left:that.position().left-tooltip.width()-that.width()})}else{tooltip.css("display","none")}});jQuery(document).on("click",".chat_unmute",function(){addMessage("/unmute id "+jQuery(this).parent().attr("player_id"));$("div#chat_muted_tooltip").css("display","none")});jQuery(document).on("click",".chat_ban,.chat_mute",function(){that=jQuery(this);tooltip=$("div#chat_command_menu");if(tooltip.css("display")=="none"){last_child=tooltip.find("div:last-child");last_child.find("span").css("display",that.hasClass("chat_ban")?"inline":"none").find("input:checkbox").attr("checked","checked");last_child.find("input:text").val(that.hasClass("chat_ban")?L_chat_advanced_online_banned_via_chat:"");tooltip.find("#chat_command").html((that.hasClass("chat_ban")?L_chat_advanced_online_ban:L_chat_advanced_online_mute).replace("%1$s",that.parent().next().html()));tooltip.attr("command",that.hasClass("chat_ban")?"ban":"mute").attr("player_id",that.parent().attr("player_id")).css({display:"block",position:"absolute",top:that.position().top+that.height(),left:that.position().left-that.width()-tooltip.width()})}else{tooltip.css("display","none")}});jQuery(document).on("click","#chat_command_menu div:not(:first-child):not(:last-child)",function(a){that=jQuery(this);command=that.parent().attr("command");menu=$("div#chat_command_menu");addMessage("/"+command+" id "+that.parent().attr("player_id")+" "+that.attr("interval")+(menu.find("input:checkbox").is("[checked]")?"":"!")+" "+menu.find("input:text").val());menu.css("display","none")});jQuery(document).on("mouseenter",".chat_unmute",function(){that=jQuery(this);tooltip=$("div#chat_muted_tooltip");if(tooltip.css("display")=="none"){tooltip.html(L_chat_advanced_online_unmute.replace("%1$s",that.parent().next().html())).css({display:"block",position:"absolute",top:that.position().top+that.height(),left:that.position().left-tooltip.width()-that.width()})}else{tooltip.css("display","none")}});jQuery(document).on("click change","[chat_history_go]",function(a){is_select=(that=jQuery(this))[0].tagName=="SELECT";if(a.type=="change"||!is_select){document.location.assign("index.php?page=chat_msg&ally="+ally_id+"&history="+IS_HISTORY+"&sheet="+(is_select?that.val():that.attr("chat_history_go")))}});$(document).on("click","#chat_smile_point",function(a){tooltip=$("div#chat_message_smiles2");offset=$(this).offset();if(tooltip.css("display")=="none"){tooltip.css({display:"block",position:"absolute",top:offset.top-tooltip.height()-15,left:offset.left-tooltip.width()/3})}else{tooltip.css("display","none")}});jQuery(document).on("click","[smile]",function(){addSmiley($(this).attr("smile"));$("div#chat_message_smiles2").css("display","none")});jQuery(document).on("click","#chat_message_smiles2",function(){$(this).css("display","none")});$(document).on("click","#chat_color_button",function(){tooltip=$("div#chat_color_select");offset=$(this).offset();if(tooltip.css("display")=="none"){tooltip.css({display:"block",position:"absolute",top:offset.top-tooltip.height()-15,left:offset.left-tooltip.width()/3})}else{tooltip.css("display","none")}});jQuery(document).on("click","#chat_color_select div",function(){$("#chat_color").val($(this).attr("color"));$("#chat_message_inputs #msg").css("color",$(this).attr("color"));$("div#chat_color_select").css("display","none")});jQuery(document).on("click","#chat_color_select",function(){$(this).css("display","none")});function addSmiley(b,a){jQuery("#chat_box #msg").val((a?b:"")+jQuery("#chat_box #msg").val()+(a?"":b));document.chat_form.msg.focus()}function addMessage(a){!a?a=jQuery("#msg").val():false;if(!a){return}jQuery.post("index.php?page=chat_add",{ally:ally_id,message:a,color:jQuery("#chat_color").val()}).always(function(){showMessage()});jQuery("#msg").val("").focus()}function showMessage(a){if(chat_refreshing||chat_disabled){return}chat_refreshing=true;jQuery.post("index.php?page=chat_msg",{page:"chat_msg",ally:ally_id,last_message:chat_last_message},function(e){var b=$("*:focus").get(0);if(e.html){chat_last_message=e.last_message;var c=jQuery("#shoutbox");c.html(c.html()+e.html);c.animate({scrollTop:c.prop("scrollHeight")},2000);if(a!==true){sn_sound_play("chat_message")}}if(e.users_total){jQuery(".js_global_users_total").html(e.users_total)}if(e.users_online){jQuery(".js_global_users_online").html(e.users_online)}if(e.online){var d=document.getElementById("onlinebox");d.innerHTML=e.online}jQuery("#online_players").html(e.online_players);jQuery("#online_invisibles").html(e.online_invisibles);if(e.chat_player_invisible==1){jQuery("#chat_player_invisible").attr("checked","checked")}else{jQuery("#chat_player_invisible").removeAttr("checked")}if(e.disable!=undefined){jQuery("#msg,#send,#chat_color").attr("disabled","disabled");jQuery("#chat_message_inputs, #chat_message_smiles, #chat_online_wrapper").hide();jQuery("#chat_message_refresh").css("display","table-row");chat_disabled=true}else{jQuery("#msg,#send,#chat_color").removeAttr("disabled");if(b){b.focus()}chat_refreshing=false;window.setTimeout(showMessage,chat_refresh_rate)}},"json").always(function(b){if(!chat_disabled){window.setTimeout(showMessage,chat_refresh_rate)}})};