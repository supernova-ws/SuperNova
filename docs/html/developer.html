<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="ru" xml:lang="ru">
<head>

<meta http-equiv="content-type" content="text/html; charset=windows-1251" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="ru" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="copyright" content="2009-2011 Gorlum for http://supernova.ws" />
<meta name="keywords" content="browser game, браузерка, ogame, огейм, supernova, сверхновая, xnova, ragerepack, clone, multiplayer, ога, клон" />
<meta name="description" content="Документация для разработчиков и администраторов Проекта &quot;Сверхновая&quot;. Documentation for SuperNoava developers and administrators." />
<meta name="author" content="Gorlum, gorlum@supernova.ws" />
<meta name="language" content="russian" />

<title>Для разработчиков - Документация - Сверхновая</title>

<link href="stylesheet.css" rel="stylesheet" type="text/css" media="screen, projection" />

</head>

<body id="phpbb" class="section-docs">

<div id="wrap">
  <a id="top" name="top" accesskey="t"></a>
  <div id="page-header">
    <div class="headerbar">
      <div class="inner"><span class="corners-top"><span></span></span>

      <div id="doc-description">
        <a href="../index.php" id="logo"><img src="supernova.png" alt="" /></a>
        <h1>Проект &quot;Сверхновая&quot;</h1>
        <p>Документация для разработчиков</p>
        <p style="display: none;"><a href="#start_here">Skip</a></p>
      </div>

      <span class="corners-bottom"><span></span></span></div>
    </div>
  </div>

  <a name="start_here"></a>

  <div id="page-body">

<!-- BEGIN DOCUMENT -->

<p>Сведения для разработчиков, желающих модифицировать код Проекта &quot;Сверхновая&quot;</p>

<h1>Документация для разработчиков</h1>
<div class="paragraph menu"><div class="inner"><span class="corners-top"><span></span></span><div class="content">

<ol>
  <li><a href="#defaults">Общие сведения</a>
    <ol style="list-style-type: lower-roman;">
      <li><a href="#pcg">Стандарты кодирования (Coding Guidelines)</a></li>
      <li><a href="#prefixes">Модули, подсистемы и префиксы</a></li>
      <li><a href="#versions">Версионирование</a></li>
    </ol>
  </li>

  <li><a href="#git">Использование GIT</a></li>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#git-commits">Коммиты в GIT</a></li>
  </ol>
  </li>

  <li><a href="#pte">Шаблоны</a>
<!-->
  <ol style="list-style-type: lower-roman;">
    <li><a href="#namingvars">Variable/Function/Class Naming</a></li>
  </ol>
<-->
  </li>

  <li><a href="#logs">Логи</a>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#logs_codes">Коды логов (таблица logs и errors)</a></li>
  </ol>
  </li>

<!--
  <li><a href="#styling">Styling</a>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#cfgfiles">Style Config Files</a></li>
    <li><a href="#genstyling">General Styling Rules</a></li>
  </ol></li>
  <li><a href="#templating">Templating</a>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#templates">General Templating</a></li>
    <li><a href="#inheritance">Template Inheritance</a></li>
  </ol></li>
  <li><a href="#charsets">Character Sets and Encodings</a></li>
  <li><a href="#translation">Translation (<abbr title="Internationalisation">i18n</abbr>/<abbr title="Localisation">L10n</abbr>) Guidelines</a>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#standardisation">Standardisation</a></li>
    <li><a href="#otherconsiderations">Other considerations</a></li>
    <li><a href="#writingstyle">Writing Style</a></li>
  </ol>
  </li>
  <li><a href="#vcs">VCS Guidelines</a>
  <ol style="list-style-type: lower-roman;">
    <li><a href="#repostruct">Repository structure</a></li>
    <li><a href="#commitmessage">Commit Messages and Repository Rules</a></li>
  </ol>
  </li>
  <li><a href="#changes">Guidelines Changelog</a></li>
  <li><a href="#disclaimer">Copyright and disclaimer</a></li>
-->
</ol>

</div><span class="corners-bottom"><span></span></span></div></div><hr />

<a name="defaults"></a><h2>1. Общие сведения</h2>
<div class="paragraph"><div class="inner"><span class="corners-top"><span></span></span><div class="content">

<a name="pcg"></a><h3>1.i. Стандарты кодирования (Coding Guidelines)</h3>
<p>Начиная с августа 2010 года, я  стараюсь  следовать <a href="coding-guidelines.html">phpBB3  Coding  Guidelines</a> (далее - PCG) с одним  исключением:  табуляция  расширяются  в  два  пробела  и заменяются по возможности на пробелы. Выделяются два уровня совместимости:  PCG или PCG0 - код отформатирован в соответствии с PCG; PCG1 - включает PCG0, а так же  означает,  что  переменные  названы  в  соответствии  с  PCG  и   правильно расставлены одинарные и двойные кавычки</p>

<a name="prefixes"></a><h3>1.ii. Модули, подсистемы и префиксы</h3>
<p>Предопределенные функции и пакеты<br />
<table width="700px">
<tr><th>ИД</th><th>Подсистема</th><th>Что относится к подсистеме</th></tr>
<tr><td>adm</td><td>admin</td><td>Администрирование сервера</td></tr>
<tr><td>ali</td><td>alliances</td><td>Альянсы: создание и управление</td></tr>
<tr><td>bud</td><td>buddy</td><td>Система Друзей</td></tr>
<tr><td>cht</td><td>chat</td><td>Чат</td></tr>
<tr><td>coe</td><td>combat</td><td>Боевой движок: обсчет боя между флотами,  обсчет ракетных атак, симулятор боя</td></tr>
<tr><td>eco</td><td>economic</td><td>Экономика (расчет начисления ресурсов)</td></tr>
<tr><td>eco_bld</td><td>building</td><td>Строительство и покупка юнитов (включая офицеров, исследования и работу верфей)</td></tr>
<tr><td>flt</td><td>fleet</td><td>Флоты: отправка флотов, обработка флотов в полете, обработка небоевых миссий</td></tr>
<tr><td>int</td><td>interface</td><td>Интерфейсные функции</td></tr>
<tr><td>log</td><td>logs</td><td>Система встроенных логов</td></tr>
<tr><td>msg</td><td>message</td><td>Система сообщений</td></tr>
<tr><td>reg</td><td>registration</td><td>Работа с незарегестрированными пользователями: логин, регистрация, восстановление пароля</td></tr>
<tr><td>rpg</td><td>rpg</td><td>Ролевая система (опыт, уровни, начисление ТМ, Черный Рынок итд)</td></tr>
<tr><td>sys</td><td>system</td><td>Системные функции</td></tr>
<tr><td>uni</td><td>universe</td><td>Вселенная (планеты, луны, поля обломков)</td></tr>
<tr><th>sn</th><th>supernova</th><th>Функции, не относящиеся к какому-либо из вышеперечисленных блоков</th></tr>
</table>
</p>

<a name="versions"></a><h3>1.iii. Версионирование</h3>
<p>
  Сверхновая состоит из двух взаимосвязанных компонентов: PHP-движка и базы данных MySQL.
  Версионизация каждого из компонентов осуществляется отдельно.
</p>

<p>
  В БД Сверхновой в таблце <code>config</code> в записи с ключом <code>`config_name` = 'db_version'</code> хранится её текущая версия.
  Версия БД - число, которое увеличивается каждый раз при изменении структуры БД.
</p>

<p>
  Движок Сверхновой версионируются строкой <code>&lt;version&gt;&lt;stage&gt;[&lt;edition&gt;][r&lt;revision&gt;]</code>, где
  <ul>
    <li><code>&lt;version&gt;</code> - версия Сверхновой. Увеличивается при одноразовом значительном изменении в
      коде движка (новая фишка, переписывание целой подсистемы итд), при накоплении большого числа мелких правок или
      при изменении версии БД.</li>
    <li>
      <code>&lt;stage&gt;</code> - этап текущей версии. Строчная буква английского алфавита, увеличивающаяся при переходе на
      следующий этап работы над движком. Может принимать следующие значения:
      <ul>
        <li><code>a</code> - "alpha" - предварительная "скелетная" версия. На публике появляется в качестве "proof of conception"
          и используется для оценки востребованности изменения, предварительной демонстрации возможностей, поиска грубых ошибок в
          логике работы итд</li>
        <li><code>b</code> - "beta"</li>
        <li><code>c</code> - "candidate"</li>
        <li><code>d</code> - "deployment"</li>
        <li><code>e</code> - "extra"</li>
        <li><code>f</code> - "fixes"</li>
<!--
        <li><code>b</code> - "beta". На публике появляется в качестве "proof of conception"
        и используется для оценки востребованности изменения, предварительной демонстрации возможностей, поиска грубых ошибок в
        логике работы итд</li>
-->
      </ul>
    </li>
    <li><code>&lt;edition&gt;</code> - редакция очередного этапа текущей версии. Необязательный параметр. Изменяется при необходимости
    отметить модификацию кода на текущем этапе</li>
    <li><code>r&lt;revision&gt;</code> - ревизия движка. Необязательный параметр. Изменяется автоматически системой контроля версии.
      Добавляется, когда необходимо различать редакции Сверхновой</li>
  </ul>
</p>

<p>
  В движке вместе с номером его версиии хранится так же требуемая версия БД. Если движок запустить на версии БД выше, чем та, с
  которой он может работать, движок прекратит свою работу с сообщением об ошибке. В нормальных условиях такого произойти не должно.
  Такое может произойти, например, при восстановлении бэкапа более новой версии БД на старый движок.  Данный механизм призван блокировать
  возможные повреждения структуры БД в случае ошибок администратора сервера, сбоев в скрипте резервирования/восстановления, хакерской
  атаки итд.
</p>

<p>
  В движок встроен автоапдейтер структуры БД. Поэтому если более новая версия движка будет запущена на старой версии БД, он
  автоматически производет необходимые изменения в структуре базы (включая все необходимые перерасчеты). Поэтому в случае необходимости
  можно восстанавливать старые бэкапы БД на новую версию движка.
</p>

</div><div class="back2top"><a href="#wrap" class="top">Back to Top</a></div><span class="corners-bottom"><span></span></span></div></div><hr />

<a name="git"></a><h2>Использование GIT</h2>
<div class="paragraph"><div class="inner"><span class="corners-top"><span></span></span><div class="content">

<a name="git-commits"></a><h3>Коммиты в GIT</h3>

<p>
  Начиная с версии 26 описание коммитов в GIT-репозиториях стандартизировано. Они имеют следующий формат:<br />
  <code>&lt;type&gt;-&lt;subsystem_affected&gt;&lt;comment&gt;</code>
  <ul>где
    <li><code>type</code> - тип коммита. Может принимать следующие значения:
      <ul>
        <li><code>release</code> - релиз движка. В комментарии указывается тэг, по которому можно получить данный релиз</li>
        <li><code>crit</code> - устранена критическая ошибка в коде или уязвимость. Необходимо срочно установить это обновление</li>
        <li><code>fix</code> - устранена ошибка в коде. Крайне желательно установить это обновление</li>
        <li><code>feature</code> - обновление добавляет новую небольшую фичу в движок (большая фича меняет номер версии). Можно поставить это
          обновление, можно дождаться очередного релиза</li>
        <li><code>misc</code> - мелкое изменение, не влияющее на игру. Например - изменение форматирования для соответствия PCG1, переименование
          переменных, небольшие изменения в алгоритмах и т.д.</li>
        <li><code>doc</code> - изменение в документации</li>
        <li><code>work</code> - промежуточный рабочий коммит. Обычно делается что бы зафиксировать работу над текущими изменениями в проекте, переключиться в другую ветку,
          внести изменения в конфигурацию GIT итд. Серия таких коммитов закрывается одним из вышеперечисленных типов.
        </li>
      </ul>
    </li>
    <li><code>subsystem_affected</code> - список <a href="#prefixes">кодов подсистем</a>, которые затрагивает этот коммит. Если их несколько, то они разделяются знаком "+"</li>
    <li><code>comment</code> - краткое описание коммита</li>
  </ul>
</p>

<p>
</p>

</div><div class="back2top"><a href="#wrap" class="top">Back to Top</a></div><span class="corners-bottom"><span></span></span></div></div><hr />

<a name="pte"></a><h2>2. Шаблоны</h2>
<div class="paragraph"><div class="inner"><span class="corners-top"><span></span></span><div class="content">

<p>Движок использует phpBB3 Tepmlate Engine (далее - PTE). PTE доработан до полной
обратной  совместимости  со  старым  template-движком  XNova,  а  так  же   для
совместимости с моими новвоведениями. В частности,  доработанный  PTE  понимает
название переменных из шаблона, написанные маленькими буквами; переменные  вида
L_xxx разворачиваются в переменную $lang['xxx']; поддерживаются индексированные
значения переменных вида xxx[yyy]. Подробнее о формате темплейтов можно  узнать
в <a href="coding-guidelines.html">PCG</a> и на форумах  поддержки
phpBB3.</p>
<p>Шаблоны  хранятся в каталоге <code>/design/templates/&lt;имя шаблона&gt;</code>. В
настоящее время имеют расширение .TPL, а не .HTML, как в оригинальном PTE</p>

</div><div class="back2top"><a href="#wrap" class="top">Back to Top</a></div><span class="corners-bottom"><span></span></span></div></div><hr />

<a name="logs"></a><h2>3. Логи</h2>
<div class="paragraph"><div class="inner"><span class="corners-top"><span></span></span><div class="content">

<p>Сверхновая имеет встроенную систему логов для облегчения работы администрации сервера</p>

<a name="logs_codes"></a><h3>3.i. Коды логов (таблица logs)</h3>
<p>
<table width="700px">
<tr><th>0</th><th>Код по умолчанию</th></tr>

<tr><th>100</th><th>Информационные коды</th></tr>
<tr><td>102</td><td>Изменение количества Темной Материи</td></tr>
<tr><td>103</td><td>Изменение структуры БД</td></tr>
<tr><td>190</td><td>Запуск обновления статистики игроков</td></tr>
<tr><td>191</td><td>Запуск обновления статистики игроков</td></tr>
<tr><td>192</td><td>Обновление статистики игроков выполнено успешно</td></tr>
<br />
<tr><th>2xx</th><th>Операция завершена успешно</th></tr>
<tr><td>200</td><td>OK</td></tr>
<!-->
<tr><td>201</td><td>Created</td></tr>
<tr><td>202</td><td>Accepted</td></tr>
<tr><td>203</td><td>Non-Authoritative Information</td></tr>
<tr><td>204</td><td>No Content</td></tr>
<tr><td>205</td><td>Reset Content</td></tr>
<tr><td>206</td><td>Partial Content</td></tr>
<-->
<tr><th>3xx</th><th>Предупреждения системы логов</th></tr>
<tr><th>300</th><th>Общий код по умолчанию</th></tr>
<tr><td>301</td><td>Возможный багоюз. Когда-то данное действие пользователя приводило к ошибке, дающей ему неоправданное преимущество в игре (удвоение  флота, бесплатная или моментальная постройка итд), т.е. являлось хаком. Сейчас эта ошибка устранена, но стоит присмотрется к пользователю - возможно он багоюзер или хакер.</td></tr>
<tr><td>302</td><td>Попытка взлома. Пользователь передал серверу  данные, не совпадаю реальными (например - другой ID пользователя вместо своего, другой ID альянса, вместо своего итд). Обычно это означает попытку взлома. Очень редко это может означать о наличии ошибки в коде игры</td></tr>
<tr><td>303</td><td>Пользователь не найден в системе. Это может означать, что пользователь на странице логина или регестрируется. Или это может означать ошибку</td></tr>
<tr><td>304</td><td>Колонизация с несколькими кораблями</td></tr>
<tr><td>305</td><td>Попытка взлома. Пользователь передал отрицательное количество ресурсов на странице Черный Рынок->Торговец ресурсами. В нормальных условиях это сделать невозможно. До фикса это приводило к увеличению ресурса на указанную величину.</td></tr>
<tr><td>306</td><td>Попытка взлома. Пользователь передал в списке кораблей на странице Черный Рынок не-корабль. В нормальных условиях это сделать невозможно.</td></tr>
<tr><td>307</td><td>Попытка взлома. Пользователь передал отрицательное количество кораблей на странице Черный Рынок. В нормальных условиях это сделать невозможно.</td></tr>
<tr><td>399</td><td>Запись системы слежения за игроками</td></tr>
<br />
<tr><th>4xx</th><th>Ошибки при запросе клиента</th></tr>
<tr><td>401</td><td>Unauthorized. Пользователь попытался получить доступ к части сайта, не доступной для его уровня доступа</td></tr>
<tr><td>402</td><td>Ошибка изменения количества Темной Материи</td></tr>
<!--><br />
  400 Bad Request<br />
  403 Forbidden<br />
  404 Not Found<br />
  405 Method Not Allowed<br />
  406 Not Acceptable<br />
  407 Proxy Authentication Required<br />
  408 Request Timeout<br />
  409 Conflict<br />
  410 Gone<br />
  411 Length Required<br />
  412 Precondition Failed<br />
  413 Request Entity Too Large<br />
  414 Request-URI Too Long<br />
  415 Unsupported Media Type<br />
  416 Requested Range Not Satisfiable<br />
  417 Expectation Failed<br />
<--><br />
<tr><th>500</th><th>Ошибки сервера - сбой в БД или ошибки в коде движка</th></tr>
<tr><td>501</td><td>У игрока отрицательное количество ресурсов</td></tr>
<tr><td>502</td><td>Ошибка записи пользователя: у пользователя в качестве родного мира назначена несуществующая планета</td></tr>
<tr><td>503</td><td>У планеты нет хозяина</td></tr>
<tr><td>504</td><td>Таймаут менеджера флотов</td></tr>
<!--><br />
  501 Not Implemented<br />
  502 Bad Gateway<br />
  503 Service Unavailable<br />
  504 Gateway Timeout<br />
  505 HTTP Version Not Supported<br />
<-->
</table>
</p>
</div><div class="back2top"><a href="#wrap" class="top">Back to Top</a></div><span class="corners-bottom"><span></span></span></div></div><hr />

<!-- END DOCUMENT -->

  <div id="page-footer">
    <div class="version">Version</div>
  </div>
</div></div>

<div>
  <a id="bottom" name="bottom" accesskey="z"></a>
</div>

</body>
</html>
